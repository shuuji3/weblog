<!doctype html><html class=no-js lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><meta property="og:description" content><meta name=author content="map[]"><meta property="og:title" content="Dockerを使用したGitLab Runnerのインストール方法"><meta property="twitter:title" content="Dockerを使用したGitLab Runnerのインストール方法"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><base href=https://weblog.shuuji3.xyz/><title>Dockerを使用したGitLab Runnerのインストール方法 - Weblog by shuuji3</title><link rel=canonical href=https://weblog.shuuji3.xyz/post/2021-03-30-run-gitlab-runner-by-docker/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/Gilroy-ExtraBold.css><link rel=stylesheet href=/css/Gilroy-Light.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100..700&display=swap" rel=stylesheet><link rel=stylesheet href=https://weblog.shuuji3.xyz/main.min.48ae98f393bb0fe58e3df2b4d8f1ae88ef6d38cd622c97ebe7dc2283d8182bdb.css emotion=🤩></head><body lang=en><div class=wrapper-masthead><div class=container><header class="masthead clearfix"><a href=https://weblog.shuuji3.xyz/ class=site-avatar><img src=/images/emoji-google-unicorn-face.png></a><div class=site-info><h1 class=site-name><a href=https://weblog.shuuji3.xyz/>Weblog by shuuji3</a></h1><p class=site-description>Happy Software Engineering</p></div><nav><a href=https://shuuji3.xyz/><i class="fa fa-home mr-1" aria-hidden=true></i> Home</a>
<a href=https://github.com/shuuji3><i class="fa fa-code mr-1" aria-hidden=true></i> GitHub</a>
<a href=/tags><i class="fa fa-tag mr-1" aria-hidden=true></i> Tags</a></nav></header></div></div><div class=container><section class=section><article class=article><h1 class=title><a href=https://weblog.shuuji3.xyz/post/2021-03-30-run-gitlab-runner-by-docker/>Dockerを使用したGitLab Runnerのインストール方法</a></h1><div class=post-metadata><p class=text-muted></p><div class="tags text-muted"><i class="fa fa-tags" aria-hidden=true></i>
<a class="button is-link code" href=/tags/gitlab>gitlab</a>
<a class="button is-link code" href=/tags/docker>docker</a></div><p class=text-muted><i class="fa fa-calendar" aria-hidden=true></i> 2021-03-30</p></div><div class=content><div class="well post-banner"></div><div class="table-of-contents toc bd-callout"><h4 class=text-muted>Table of Contents</h4><ul class=toc-h1><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#overview>Overview</a></li></ul><ul class=toc-h1><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#prerequisites>Prerequisites</a></li></ul><ul class=toc-h1><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#register-node>Register node</a></li></ul><ul class=toc-h1><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#run-the-container>Run the container</a></li></ul><ul class=toc-h1><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#references>References</a></li></ul></div><p>GitLabにGitLab Runnerをインストールすると、リポジトリでジョブを実行したり、テストやデプロイの自動化などの機能が使えるようになります。この記事では、Dockerを使用してGitLab Runnerを実行・登録する方法について説明します。</p><h2 id=overview>Overview</h2><p>次の3ステップで登録します。</p><ul><li>GitLab のトークンをチェックする</li><li>GitLab Runnerを追加したいノードでregistrationを実行</li><li>GitLab Runnerを追加したいノードでGitLab Runnerコンテナを実行</li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li>GitLab Runnerをインストールするノードで<code>docker</code>コマンドが利用できる必要があります。</li><li>ノードにGitLab v13.6.2がインストール済みで、git.your.domainで公開されているものとします。</li></ul><h2 id=register-node>Register node</h2><p>詳細な手順は以下のとおりです。</p><ul><li>管理者エリア - GitLab（<a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a>）を開きます（GitLabのAdmin権限が必要です）。</li><li>表示されている「登録トークン」をメモします。</li><li>Runnerをインストールするノードにsshします。</li><li>RunnerをGitLabにregistrationするために、次のコマンドを実行します。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -it -v /etc/gitlab-runner:/etc/gitlab-runner gitlab/gitlab-runner:latest register <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --non-interactive <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --url <span style=color:#d14>&#34;https://git.your.domain&#34;</span> <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --registration-token <span style=color:#d14>&#34;&lt;registration-token&gt;&#34;</span> <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --name <span style=color:#000;font-weight:700>$(</span>hostname -s<span style=color:#000;font-weight:700>)</span> <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --run-untagged <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --tag-list <span style=color:#d14>&#39;cluster/&lt;cluster-name&gt;,os/&lt;os-name&gt;/&lt;os-version&gt;&#39;</span> <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --executor <span style=color:#d14>&#34;docker&#34;</span> <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --docker-volumes /var/run/docker.sock:/var/run/docker.sock <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --docker-volumes /builds:/builds <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --docker-image gcr.io/buildpacks/builder <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --docker-privileged
</span></span></code></pre></div><ul><li><code>&lt;registration-token></code> には、上でメモしたトークンを書きます。</li><li><code>&lt;node-name></code> には、ノード名を書きます。例: pi-0</li><li><code>&lt;cluster-name></code> には、クラスター名を書きます。例: pi</li><li><code>&lt;os-name></code> には、OS名を書きます。例: ubuntu、centos</li><li><code>&lt;os-version></code> には、OSのバージョンを書きます。例: 20.04</li><li>これらの値は 管理者エリア - GitLab（<a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a>）に表示されるので分かりやすいように付けてください。</li><li><code>--docker-image gcr.io/buildpacks/builder</code>は、設定がない場合のデフォルトのビルドイメージを指定しています。これはGoogle Cloud Runで使用されているビルドバックで、標準のアプリの自動ビルドを可能にします。</li><li><code>--docker-privileged</code>により、コンテナがprivilegedモードで実行可能になります。これは、systemdの実行が必要なコンテナなど、Docker in Dockerを実行するために必要です。特権コンテナが不要・使えない場合は省略できます。</li><li>registrationが成功すると、次のような設定ファイルが<code>/etc/gitlab-runner/config.toml</code>に生成されます。確認してください。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>concurrent = <span style=color:#099>1</span>
</span></span><span style=display:flex><span>check_interval = <span style=color:#099>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[session_server]
</span></span><span style=display:flex><span>  session_timeout = <span style=color:#099>1800</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  [[runners]]
</span></span><span style=display:flex><span>  name = <span style=color:#d14>&#34;pi-0&#34;</span>
</span></span><span style=display:flex><span>  url = <span style=color:#d14>&#34;https://git.your.domain&#34;</span>
</span></span><span style=display:flex><span>  token = <span style=color:#d14>&#34;&lt;registration-token&gt;&#34;</span>
</span></span><span style=display:flex><span>  executor = <span style=color:#d14>&#34;docker&#34;</span>
</span></span><span style=display:flex><span>  [runners.custom_build_dir]
</span></span><span style=display:flex><span>  [runners.cache]
</span></span><span style=display:flex><span>    [runners.cache.s3]
</span></span><span style=display:flex><span>    [runners.cache.gcs]
</span></span><span style=display:flex><span>  [runners.docker]
</span></span><span style=display:flex><span>    tls_verify = <span style=color:#000;font-weight:700>false</span>
</span></span><span style=display:flex><span>    image = <span style=color:#d14>&#34;gcr.io/buildpacks/builder&#34;</span>
</span></span><span style=display:flex><span>    privileged = <span style=color:#000;font-weight:700>true</span>
</span></span><span style=display:flex><span>    disable_entrypoint_overwrite = <span style=color:#000;font-weight:700>false</span>
</span></span><span style=display:flex><span>    oom_kill_disable = <span style=color:#000;font-weight:700>false</span>
</span></span><span style=display:flex><span>    disable_cache = <span style=color:#000;font-weight:700>false</span>
</span></span><span style=display:flex><span>    volumes = [<span style=color:#d14>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span>, <span style=color:#d14>&#34;/builds:/builds&#34;</span>, <span style=color:#d14>&#34;/cache&#34;</span>]
</span></span><span style=display:flex><span>    shm_size = <span style=color:#099>0</span>
</span></span></code></pre></div><h2 id=run-the-container>Run the container</h2><ul><li>実際に処理を行うRunnerコンテナを実行します。以下のコマンドを実行してください。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d --name gitlab-runner --restart always <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>       -v /etc/gitlab-runner/:/etc/gitlab-runner/ <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>       -v /var/run/docker.sock:/var/run/docker.sock <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>       gitlab/gitlab-runner
</span></span></code></pre></div><ul><li><code>"--restart always"</code>オプションを指定することで、再起動時にコンテナが自動起動するようになります。</li><li><a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a> にノードが表示されればインストール完了です。ランナー実行時にジョブが割り当てられるようになったはずです。</li></ul><h2 id=references>References</h2><ul><li><a href=https://docs.gitlab.com/runner/install/>Install GitLab Runner | GitLab</a></li></ul><h2>Comments</h2><script src=https://utteranc.es/client.js repo=shuuji3/weblog issue-term=pathname label=utterances theme=github-light crossorigin=anonymous async></script></div></article></section></div><div class=container><div class=pagination><a class="btn btn-primary text-white pull-right" href=https://weblog.shuuji3.xyz/post/2021-02-17-wish-to-publish-my-knowledge/><i class="fa fa-chevron-left" aria-hidden=true></i> Previous</a>
<a class="btn btn-primary text-white pull-right" href=https://weblog.shuuji3.xyz/post/2022-12-02-today-i-learned/>Next <i class="fa fa-chevron-right" aria-hidden=true></i></a></div></div><div class=wrapper-footer><div class=container><footer class=footer><a rel=license href=https://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License CC-BY 4.0" src=/images/cc-by.svg></a>
<a href=https://gohugo.io/><img src=/images/powered-by-hugo.svg alt="powered by hugo"></a><p>This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License (CC-BY 4.0)
</a>.</p><p>This website uses <a href=https://analytics.google.com/>Google Analytics</a>
to understand users and provide better contents.</p></footer></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-7053288-5","auto"),ga("send","pageview"))</script></body></html>