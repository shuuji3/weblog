<!doctype html><html class=no-js lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><meta property="og:description" content><meta name=author content="map[]"><meta property="og:title" content="Dockerã‚’ä½¿ç”¨ã—ãŸGitLab Runnerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•"><meta property="twitter:title" content="Dockerã‚’ä½¿ç”¨ã—ãŸGitLab Runnerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><base href=https://weblog.shuuji3.xyz/><title>Dockerã‚’ä½¿ç”¨ã—ãŸGitLab Runnerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³• - Weblog by shuuji3</title><link rel=canonical href=https://weblog.shuuji3.xyz/post/2021-03-30-run-gitlab-runner-by-docker/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/Gilroy-ExtraBold.css><link rel=stylesheet href=/css/Gilroy-Light.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100..700&display=swap" rel=stylesheet><link rel=stylesheet href=https://weblog.shuuji3.xyz/main.min.a137c39ae4eedac73904262b7d6fca1d7e73c08e8f1d28fec9fad966d81f0ec0.css emotion=ğŸ¤©></head><body lang=en><div class=wrapper-masthead><div class=container><header class="masthead clearfix"><a href=https://weblog.shuuji3.xyz// class=site-avatar><img src=/images/emoji-google-unicorn-face.png></a><div class=site-info><h1 class=site-name><a href=https://weblog.shuuji3.xyz//>Weblog by shuuji3</a></h1><p class=site-description>Software Engineering</p></div><nav><a href=https://shuuji3.xyz/><i class="fa fa-home mr-1" aria-hidden=true></i>Home</a>
<a href=https://github.com/shuuji3><i class="fa fa-github mr-1" aria-hidden=true></i>GitHub</a>
<a href=/dashboard/blog><i class="fa fa-tag mr-1" aria-hidden=true></i>Tags</a></nav></header></div></div><div class=container><section class=section><article class=article><h1 class=title><a href=https://weblog.shuuji3.xyz/post/2021-03-30-run-gitlab-runner-by-docker/>Dockerã‚’ä½¿ç”¨ã—ãŸGitLab Runnerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•</a></h1><div class=post-metadata><p class=text-muted></p><div class="tags text-muted"><i class="fa fa-tags" aria-hidden=true></i><a class="button is-link code" href=/tags/gitlab>gitlab</a>
<a class="button is-link code" href=/tags/docker>docker</a></div><p class=text-muted><i class="fa fa-calendar" aria-hidden=true></i>March 30, 2021</p></div><div class=content><div class="well post-banner"></div><div class="table-of-contents toc bd-callout"><h4 class=text-muted>Table of Contents</h4><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#overview>Overview</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#prerequisites>Prerequisites</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#register-node>Register node</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#run-the-container>Run the container</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#references>References</a></li></ul></ul></div><p>GitLabã«GitLab Runnerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€ãƒªãƒã‚¸ãƒˆãƒªã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ãŸã‚Šã€ãƒ†ã‚¹ãƒˆã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ã®è‡ªå‹•åŒ–ãªã©ã®æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€Dockerã‚’ä½¿ç”¨ã—ã¦GitLab Runnerã‚’å®Ÿè¡Œãƒ»ç™»éŒ²ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</p><h2 id=overview>Overview</h2><p>æ¬¡ã®3ã‚¹ãƒ†ãƒƒãƒ—ã§ç™»éŒ²ã—ã¾ã™ã€‚</p><ul><li>GitLab ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹</li><li>GitLab Runnerã‚’è¿½åŠ ã—ãŸã„ãƒãƒ¼ãƒ‰ã§registrationã‚’å®Ÿè¡Œ</li><li>GitLab Runnerã‚’è¿½åŠ ã—ãŸã„ãƒãƒ¼ãƒ‰ã§GitLab Runnerã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œ</li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li>GitLab Runnerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒãƒ¼ãƒ‰ã§<code>docker</code>ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li><li>ãƒãƒ¼ãƒ‰ã«GitLab v13.6.2ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã€git.your.domainã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚</li></ul><h2 id=register-node>Register node</h2><p>è©³ç´°ãªæ‰‹é †ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚</p><ul><li>ç®¡ç†è€…ã‚¨ãƒªã‚¢ - GitLabï¼ˆ<a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a>ï¼‰ã‚’é–‹ãã¾ã™ï¼ˆGitLabã®Adminæ¨©é™ãŒå¿…è¦ã§ã™ï¼‰ã€‚</li><li>è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã€Œç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚</li><li>Runnerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒãƒ¼ãƒ‰ã«sshã—ã¾ã™ã€‚</li><li>Runnerã‚’GitLabã«registrationã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</li></ul><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>docker run --rm -it -v /etc/gitlab-runner:/etc/gitlab-runner gitlab/gitlab-runner:latest register <span class=se>\
</span><span class=se></span>    --non-interactive <span class=se>\
</span><span class=se></span>    --url <span class=s2>&#34;https://git.your.domain&#34;</span> <span class=se>\
</span><span class=se></span>    --registration-token <span class=s2>&#34;&lt;registration-token&gt;&#34;</span> <span class=se>\
</span><span class=se></span>    --name <span class=k>$(</span>hostname -s<span class=k>)</span> <span class=se>\
</span><span class=se></span>    --run-untagged <span class=se>\
</span><span class=se></span>    --tag-list <span class=s1>&#39;cluster/&lt;cluster-name&gt;,os/&lt;os-name&gt;/&lt;os-version&gt;&#39;</span> <span class=se>\
</span><span class=se></span>    --executor <span class=s2>&#34;docker&#34;</span> <span class=se>\
</span><span class=se></span>    --docker-volumes /var/run/docker.sock:/var/run/docker.sock <span class=se>\
</span><span class=se></span>    --docker-volumes /builds:/builds <span class=se>\
</span><span class=se></span>    --docker-image gcr.io/buildpacks/builder <span class=se>\
</span><span class=se></span>    --docker-privileged
</code></pre></div><ul><li><code>&lt;registration-token></code> ã«ã¯ã€ä¸Šã§ãƒ¡ãƒ¢ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›¸ãã¾ã™ã€‚</li><li><code>&lt;node-name></code> ã«ã¯ã€ãƒãƒ¼ãƒ‰åã‚’æ›¸ãã¾ã™ã€‚ä¾‹: pi-0</li><li><code>&lt;cluster-name></code> ã«ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åã‚’æ›¸ãã¾ã™ã€‚ä¾‹: pi</li><li><code>&lt;os-name></code> ã«ã¯ã€OSåã‚’æ›¸ãã¾ã™ã€‚ä¾‹: ubuntuã€centos</li><li><code>&lt;os-version></code> ã«ã¯ã€OSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›¸ãã¾ã™ã€‚ä¾‹: 20.04</li><li>ã“ã‚Œã‚‰ã®å€¤ã¯ ç®¡ç†è€…ã‚¨ãƒªã‚¢ - GitLabï¼ˆ<a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a>ï¼‰ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ä»˜ã‘ã¦ãã ã•ã„ã€‚</li><li><code>--docker-image gcr.io/buildpacks/builder</code>ã¯ã€è¨­å®šãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ“ãƒ«ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯Google Cloud Runã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ“ãƒ«ãƒ‰ãƒãƒƒã‚¯ã§ã€æ¨™æº–ã®ã‚¢ãƒ—ãƒªã®è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚</li><li><code>--docker-privileged</code>ã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠãŒprivilegedãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€systemdã®å®Ÿè¡ŒãŒå¿…è¦ãªã‚³ãƒ³ãƒ†ãƒŠãªã©ã€Docker in Dockerã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚ç‰¹æ¨©ã‚³ãƒ³ãƒ†ãƒŠãŒä¸è¦ãƒ»ä½¿ãˆãªã„å ´åˆã¯çœç•¥ã§ãã¾ã™ã€‚</li><li>registrationãŒæˆåŠŸã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒ<code>/etc/gitlab-runner/config.toml</code>ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚</li></ul><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml><span class=nx>concurrent</span> <span class=p>=</span> <span class=mi>1</span>
<span class=nx>check_interval</span> <span class=p>=</span> <span class=mi>0</span>

<span class=p>[</span><span class=nx>session_server</span><span class=p>]</span>
  <span class=nx>session_timeout</span> <span class=p>=</span> <span class=mi>1800</span>

  <span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;pi-0&#34;</span>
  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://git.your.domain&#34;</span>
  <span class=nx>token</span> <span class=p>=</span> <span class=s2>&#34;&lt;registration-token&gt;&#34;</span>
  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>custom_build_dir</span><span class=p>]</span>
  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>]</span>
    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>s3</span><span class=p>]</span>
    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>gcs</span><span class=p>]</span>
  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
    <span class=nx>tls_verify</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;gcr.io/buildpacks/builder&#34;</span>
    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
    <span class=nx>disable_entrypoint_overwrite</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>oom_kill_disable</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>disable_cache</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span><span class=p>,</span> <span class=s2>&#34;/builds:/builds&#34;</span><span class=p>,</span> <span class=s2>&#34;/cache&#34;</span><span class=p>]</span>
    <span class=nx>shm_size</span> <span class=p>=</span> <span class=mi>0</span>
</code></pre></div><h2 id=run-the-container>Run the container</h2><ul><li>å®Ÿéš›ã«å‡¦ç†ã‚’è¡Œã†Runnerã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</li></ul><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>docker run -d --name gitlab-runner --restart always <span class=se>\
</span><span class=se></span>       -v /etc/gitlab-runner/:/etc/gitlab-runner/ <span class=se>\
</span><span class=se></span>       -v /var/run/docker.sock:/var/run/docker.sock <span class=se>\
</span><span class=se></span>       gitlab/gitlab-runner
</code></pre></div><ul><li><code>"--restart always"</code>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€å†èµ·å‹•æ™‚ã«ã‚³ãƒ³ãƒ†ãƒŠãŒè‡ªå‹•èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</li><li><a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a> ã«ãƒãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ã§ã™ã€‚ãƒ©ãƒ³ãƒŠãƒ¼å®Ÿè¡Œæ™‚ã«ã‚¸ãƒ§ãƒ–ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã¯ãšã§ã™ã€‚</li></ul><h2 id=references>References</h2><ul><li><a href=https://docs.gitlab.com/runner/install/>Install GitLab Runner | GitLab</a></li></ul></div></article></section></div><div class=container><div class=pagination><a class="btn btn-secondary pull-right" href=https://weblog.shuuji3.xyz/post/2021-02-17-wish-to-publish-my-knowledge/><i class="fa fa-chevron-left" aria-hidden=true></i>Previous</a>
<a class="btn btn-secondary pull-right" href=https://weblog.shuuji3.xyz/post/2022-12-02-today-i-learned/>Next <i class="fa fa-chevron-right" aria-hidden=true></i></a></div></div><div class=wrapper-footer><div class=container><footer class=footer><a rel=license href=https://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License CC-BY 4.0" src=/images/cc-by.svg></a>
<a href=https://gohugo.io/><img src=/images/powered-by-hugo.svg alt="powered by hugo"></a><p>This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License (CC-BY 4.0)
</a>.</p><p>This website uses <a href=https://analytics.google.com/>Google Analytics</a>
to understand users and provide better contents.</p></footer></div></div><script src=/js/dist/vendor/jquery/jquery.min.js></script><script src=/js/dist/vendor/tether/tether.min.js></script><script src=/js/dist/vendor/bootstrap/bootstrap.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-7053288-5','auto');ga('send','pageview');}</script></body></html>