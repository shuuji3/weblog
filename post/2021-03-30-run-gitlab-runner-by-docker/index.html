<!doctype html><html class=no-js lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><meta property="og:description" content><meta name=author content="map[]"><meta property="og:title" content="Dockerを使用したGitLab Runnerのインストール方法"><meta property="twitter:title" content="Dockerを使用したGitLab Runnerのインストール方法"><link rel=apple-touch-icon sizes=180x180 href=/images/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicons/favicon-16x16.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><base href=https://weblog.shuuji3.xyz/><title>Dockerを使用したGitLab Runnerのインストール方法 - Weblog by shuuji3</title><link rel=canonical href=https://weblog.shuuji3.xyz/post/2021-03-30-run-gitlab-runner-by-docker/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/Gilroy-ExtraBold.css><link rel=stylesheet href=/css/Gilroy-Light.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100..700&display=swap" rel=stylesheet><link rel=stylesheet href=https://weblog.shuuji3.xyz/main.min.a137c39ae4eedac73904262b7d6fca1d7e73c08e8f1d28fec9fad966d81f0ec0.css emotion=🤩></head><body lang=en><div class=wrapper-masthead><div class=container><header class="masthead clearfix"><a href=https://weblog.shuuji3.xyz// class=site-avatar><img src=/images/emoji-google-unicorn-face.png></a><div class=site-info><h1 class=site-name><a href=https://weblog.shuuji3.xyz//>Weblog by shuuji3</a></h1><p class=site-description>Software Engineering</p></div><nav><a href=https://shuuji3.xyz/><i class="fa fa-home mr-1" aria-hidden=true></i>Home</a>
<a href=https://github.com/shuuji3><i class="fa fa-github mr-1" aria-hidden=true></i>GitHub</a>
<a href=/dashboard/blog><i class="fa fa-tag mr-1" aria-hidden=true></i>Tags</a></nav></header></div></div><div class=container><section class=section><article class=article><h1 class=title><a href=https://weblog.shuuji3.xyz/post/2021-03-30-run-gitlab-runner-by-docker/>Dockerを使用したGitLab Runnerのインストール方法</a></h1><div class=post-metadata><p class=text-muted></p><div class="tags text-muted"><i class="fa fa-tags" aria-hidden=true></i><a class="button is-link code" href=/tags/gitlab>gitlab</a>
<a class="button is-link code" href=/tags/docker>docker</a></div><p class=text-muted><i class="fa fa-calendar" aria-hidden=true></i>March 30, 2021</p></div><div class=content><div class="well post-banner"></div><div class="table-of-contents toc bd-callout"><h4 class=text-muted>Table of Contents</h4><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#overview>Overview</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#prerequisites>Prerequisites</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#register-node>Register node</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#run-the-container>Run the container</a></li></ul></ul><ul class=toc-h1><ul class=toc-h2><li><a href=/post/2021-03-30-run-gitlab-runner-by-docker/#references>References</a></li></ul></ul></div><p>GitLabにGitLab Runnerをインストールすると、リポジトリでジョブを実行したり、テストやデプロイの自動化などの機能が使えるようになります。この記事では、Dockerを使用してGitLab Runnerを実行・登録する方法について説明します。</p><h2 id=overview>Overview</h2><p>次の3ステップで登録します。</p><ul><li>GitLab のトークンをチェックする</li><li>GitLab Runnerを追加したいノードでregistrationを実行</li><li>GitLab Runnerを追加したいノードでGitLab Runnerコンテナを実行</li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li>GitLab Runnerをインストールするノードで<code>docker</code>コマンドが利用できる必要があります。</li><li>ノードにGitLab v13.6.2がインストール済みで、git.your.domainで公開されているものとします。</li></ul><h2 id=register-node>Register node</h2><p>詳細な手順は以下のとおりです。</p><ul><li>管理者エリア - GitLab（<a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a>）を開きます（GitLabのAdmin権限が必要です）。</li><li>表示されている「登録トークン」をメモします。</li><li>Runnerをインストールするノードにsshします。</li><li>RunnerをGitLabにregistrationするために、次のコマンドを実行します。</li></ul><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>docker run --rm -it -v /etc/gitlab-runner:/etc/gitlab-runner gitlab/gitlab-runner:latest register <span class=se>\
</span><span class=se></span>    --non-interactive <span class=se>\
</span><span class=se></span>    --url <span class=s2>&#34;https://git.your.domain&#34;</span> <span class=se>\
</span><span class=se></span>    --registration-token <span class=s2>&#34;&lt;registration-token&gt;&#34;</span> <span class=se>\
</span><span class=se></span>    --name <span class=k>$(</span>hostname -s<span class=k>)</span> <span class=se>\
</span><span class=se></span>    --run-untagged <span class=se>\
</span><span class=se></span>    --tag-list <span class=s1>&#39;cluster/&lt;cluster-name&gt;,os/&lt;os-name&gt;/&lt;os-version&gt;&#39;</span> <span class=se>\
</span><span class=se></span>    --executor <span class=s2>&#34;docker&#34;</span> <span class=se>\
</span><span class=se></span>    --docker-volumes /var/run/docker.sock:/var/run/docker.sock <span class=se>\
</span><span class=se></span>    --docker-volumes /builds:/builds <span class=se>\
</span><span class=se></span>    --docker-image gcr.io/buildpacks/builder <span class=se>\
</span><span class=se></span>    --docker-privileged
</code></pre></div><ul><li><code>&lt;registration-token></code> には、上でメモしたトークンを書きます。</li><li><code>&lt;node-name></code> には、ノード名を書きます。例: pi-0</li><li><code>&lt;cluster-name></code> には、クラスター名を書きます。例: pi</li><li><code>&lt;os-name></code> には、OS名を書きます。例: ubuntu、centos</li><li><code>&lt;os-version></code> には、OSのバージョンを書きます。例: 20.04</li><li>これらの値は 管理者エリア - GitLab（<a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a>）に表示されるので分かりやすいように付けてください。</li><li><code>--docker-image gcr.io/buildpacks/builder</code>は、設定がない場合のデフォルトのビルドイメージを指定しています。これはGoogle Cloud Runで使用されているビルドバックで、標準のアプリの自動ビルドを可能にします。</li><li><code>--docker-privileged</code>により、コンテナがprivilegedモードで実行可能になります。これは、systemdの実行が必要なコンテナなど、Docker in Dockerを実行するために必要です。特権コンテナが不要・使えない場合は省略できます。</li><li>registrationが成功すると、次のような設定ファイルが<code>/etc/gitlab-runner/config.toml</code>に生成されます。確認してください。</li></ul><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml><span class=nx>concurrent</span> <span class=p>=</span> <span class=mi>1</span>
<span class=nx>check_interval</span> <span class=p>=</span> <span class=mi>0</span>

<span class=p>[</span><span class=nx>session_server</span><span class=p>]</span>
  <span class=nx>session_timeout</span> <span class=p>=</span> <span class=mi>1800</span>

  <span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;pi-0&#34;</span>
  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://git.your.domain&#34;</span>
  <span class=nx>token</span> <span class=p>=</span> <span class=s2>&#34;&lt;registration-token&gt;&#34;</span>
  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>custom_build_dir</span><span class=p>]</span>
  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>]</span>
    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>s3</span><span class=p>]</span>
    <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>gcs</span><span class=p>]</span>
  <span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
    <span class=nx>tls_verify</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>image</span> <span class=p>=</span> <span class=s2>&#34;gcr.io/buildpacks/builder&#34;</span>
    <span class=nx>privileged</span> <span class=p>=</span> <span class=kc>true</span>
    <span class=nx>disable_entrypoint_overwrite</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>oom_kill_disable</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>disable_cache</span> <span class=p>=</span> <span class=kc>false</span>
    <span class=nx>volumes</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span><span class=p>,</span> <span class=s2>&#34;/builds:/builds&#34;</span><span class=p>,</span> <span class=s2>&#34;/cache&#34;</span><span class=p>]</span>
    <span class=nx>shm_size</span> <span class=p>=</span> <span class=mi>0</span>
</code></pre></div><h2 id=run-the-container>Run the container</h2><ul><li>実際に処理を行うRunnerコンテナを実行します。以下のコマンドを実行してください。</li></ul><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>docker run -d --name gitlab-runner --restart always <span class=se>\
</span><span class=se></span>       -v /etc/gitlab-runner/:/etc/gitlab-runner/ <span class=se>\
</span><span class=se></span>       -v /var/run/docker.sock:/var/run/docker.sock <span class=se>\
</span><span class=se></span>       gitlab/gitlab-runner
</code></pre></div><ul><li><code>"--restart always"</code>オプションを指定することで、再起動時にコンテナが自動起動するようになります。</li><li><a href=https://git.your.domain/admin/runners>https://git.your.domain/admin/runners</a> にノードが表示されればインストール完了です。ランナー実行時にジョブが割り当てられるようになったはずです。</li></ul><h2 id=references>References</h2><ul><li><a href=https://docs.gitlab.com/runner/install/>Install GitLab Runner | GitLab</a></li></ul></div></article></section></div><div class=container><div class=pagination><a class="btn btn-secondary pull-right" href=https://weblog.shuuji3.xyz/post/2021-02-17-wish-to-publish-my-knowledge/><i class="fa fa-chevron-left" aria-hidden=true></i>Previous</a>
<a class="btn btn-secondary pull-right" href=https://weblog.shuuji3.xyz/post/2022-12-02-today-i-learned/>Next <i class="fa fa-chevron-right" aria-hidden=true></i></a></div></div><div class=wrapper-footer><div class=container><footer class=footer><a rel=license href=https://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License CC-BY 4.0" src=/images/cc-by.svg></a>
<a href=https://gohugo.io/><img src=/images/powered-by-hugo.svg alt="powered by hugo"></a><p>This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License (CC-BY 4.0)
</a>.</p><p>This website uses <a href=https://analytics.google.com/>Google Analytics</a>
to understand users and provide better contents.</p></footer></div></div><script src=/js/dist/vendor/jquery/jquery.min.js></script><script src=/js/dist/vendor/tether/tether.min.js></script><script src=/js/dist/vendor/bootstrap/bootstrap.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-7053288-5','auto');ga('send','pageview');}</script></body></html>